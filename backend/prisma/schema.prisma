// Prisma Schema for R√©noVision
// Application de gestion de r√©novation

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================================================
// ENUMS
// ============================================================================

// --- Enums Utilisateur & Projet ---

enum Role {
  ADMIN
  USER
}

enum ProjetRole {
  OWNER
  MEMBER
}

// --- Enums Pi√®ces ---

enum TypePiece {
  SALON
  CUISINE
  CHAMBRE
  SDB
  WC
  BUREAU
  COULOIR
  GARAGE
  EXTERIEUR
  AUTRE
}

enum StatutPiece {
  A_FAIRE
  EN_COURS
  TERMINE
}

// --- Enums T√¢ches ---

enum StatutTache {
  A_FAIRE
  EN_COURS
  EN_ATTENTE
  TERMINE
}

enum Priorite {
  BASSE
  MOYENNE
  HAUTE
  URGENTE
}

// --- Enums Mat√©riaux ---

enum CategorieMateriau {
  PEINTURE
  REVETEMENT_SOL
  REVETEMENT_MUR
  MENUISERIE
  PLOMBERIE
  ELECTRICITE
  QUINCAILLERIE
  AUTRE
}

enum Unite {
  UNITE
  M2
  ML
  M
  L
  LITRE
  PIECE
  KG
  ROULEAU
  PACK
  LOT
}

// --- Enums Int√©gration Bancaire ---

enum StatutTransaction {
  NOUVEAU
  IGNORE
  CONVERTI
}

// ============================================================================
// MODELS
// ============================================================================

// --- User ---

model User {
  id              String    @id @default(cuid())
  email           String    @unique
  name            String
  password        String
  role            Role      @default(USER)
  budgetMaxProjet Float?
  resetToken      String?
  resetTokenExp   DateTime?

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  // Relations
  projets          ProjetUser[]
  refreshTokens    RefreshToken[]
  comptesBancaires CompteBancaire[]
  settings         UserSettings?

  @@index([deletedAt])
  @@index([email])
}

// --- UserSettings (Param√®tres utilisateur) ---

model UserSettings {
  id                    String   @id @default(cuid())
  userId                String   @unique
  notifEmail            Boolean  @default(true)
  notifPush             Boolean  @default(true)
  notifAlertesBudget    Boolean  @default(true)
  notifRappelsTaches    Boolean  @default(true)
  theme                 String   @default("dark")
  langue                String   @default("fr")
  devise                String   @default("‚Ç¨")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

// --- RefreshToken ---

model RefreshToken {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String
  expiresAt DateTime

  createdAt DateTime @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
}

// --- Projet ---

model Projet {
  id          String  @id @default(cuid())
  name        String
  description String?

  // Param√®tres du projet
  adresse   String?
  budgetMax Float?
  dateDebut DateTime?
  dateFin   DateTime?

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  // Relations
  users            ProjetUser[]
  pieces           Piece[]
  taches           Tache[]
  materiaux        Materiau[]
  credits          Credit[]
  depenses         Depense[]
  ideesPinterest   IdeePinterest[]
  moodboards       Moodboard[]
  comptesBancaires CompteBancaire[]
  categoriesCustom CategorieCustom[]

  @@index([deletedAt])
}

// --- Table pivot ProjetUser (many-to-many User <-> Projet) ---

model ProjetUser {
  projetId String
  userId   String
  role     ProjetRole @default(MEMBER)
  joinedAt DateTime   @default(now())

  // Relations
  projet Projet @relation(fields: [projetId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([projetId, userId])
  @@index([userId])
  @@index([projetId])
}

// --- Piece ---

model Piece {
  id       String      @id @default(cuid())
  projetId String
  name     String
  type     TypePiece   @default(AUTRE)
  etage    Int?
  surface  Float?
  budget   Float?
  statut   StatutPiece @default(A_FAIRE)
  images   Json?
  tags     String[]

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  // Relations
  projet     Projet          @relation(fields: [projetId], references: [id], onDelete: Cascade)
  taches     Tache[]
  materiaux  MateriauPiece[]
  depenses   Depense[]
  moodboards Moodboard[]

  @@index([projetId])
  @@index([deletedAt])
}

// --- Tache ---

model Tache {
  id          String      @id @default(cuid())
  projetId    String
  pieceId     String?
  title       String
  description String?
  statut      StatutTache @default(A_FAIRE)
  priorite    Priorite    @default(MOYENNE)
  dateDebut   DateTime?
  dateFin     DateTime?
  coutEstime  Float?
  coutReel    Float?
  pourcentage Int         @default(0)

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  // Relations
  projet     Projet      @relation(fields: [projetId], references: [id], onDelete: Cascade)
  piece      Piece?      @relation(fields: [pieceId], references: [id], onDelete: SetNull)
  sousTaches SousTache[]
  depenses   Depense[]

  // Self-referencing many-to-many pour d√©pendances
  dependances  TacheDependance[] @relation("TachePrincipale")
  dependantsDe TacheDependance[] @relation("TacheDependance")

  @@index([projetId])
  @@index([pieceId])
  @@index([deletedAt])
}

// --- Table pivot TacheDependance (self-referencing many-to-many) ---

model TacheDependance {
  tacheId      String
  dependanceId String

  // Relations
  tache      Tache @relation("TachePrincipale", fields: [tacheId], references: [id], onDelete: Cascade)
  dependance Tache @relation("TacheDependance", fields: [dependanceId], references: [id], onDelete: Cascade)

  @@id([tacheId, dependanceId])
  @@index([tacheId])
  @@index([dependanceId])
}

// --- SousTache ---

model SousTache {
  id        String  @id @default(cuid())
  tacheId   String
  title     String
  completed Boolean @default(false)
  ordre     Int     @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  tache Tache @relation(fields: [tacheId], references: [id], onDelete: Cascade)

  @@index([tacheId])
}

// --- Materiau ---

model Materiau {
  id           String            @id @default(cuid())
  projetId     String
  name         String
  categorie    CategorieMateriau @default(AUTRE)
  prixUnitaire Float?
  unite        Unite             @default(PIECE)
  reference    String?
  fournisseur  String?
  lienMarchand String?
  image        String?
  notes        String?

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  // Relations
  projet   Projet          @relation(fields: [projetId], references: [id], onDelete: Cascade)
  pieces   MateriauPiece[]
  depenses Depense[]

  @@index([projetId])
  @@index([deletedAt])
}

// --- Table pivot MateriauPiece (many-to-many Materiau <-> Piece avec quantit√©) ---

model MateriauPiece {
  materiauId String
  pieceId    String
  quantite   Float  @default(1)

  // Relations
  materiau Materiau @relation(fields: [materiauId], references: [id], onDelete: Cascade)
  piece    Piece    @relation(fields: [pieceId], references: [id], onDelete: Cascade)

  @@id([materiauId, pieceId])
  @@index([materiauId])
  @@index([pieceId])
}

// --- Credit ---

model Credit {
  id           String  @id @default(cuid())
  projetId     String
  banque       String
  montantTotal Float
  tauxInteret  Float?
  duree        Int?
  notes        String?

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  // Relations
  projet     Projet      @relation(fields: [projetId], references: [id], onDelete: Cascade)
  deblocages Deblocage[]

  @@index([projetId])
  @@index([deletedAt])
}

// --- Deblocage ---

model Deblocage {
  id            String   @id @default(cuid())
  creditId      String
  montant       Float
  dateDeblocage DateTime
  justificatifs Json?
  notes         String?

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  // Relations
  credit   Credit    @relation(fields: [creditId], references: [id], onDelete: Cascade)
  depenses Depense[]

  @@index([creditId])
  @@index([deletedAt])
}

// --- Depense ---

model Depense {
  id              String   @id @default(cuid())
  projetId        String
  montant         Float
  description     String?
  categorie       String?
  fournisseur     String?
  dateDepense     DateTime @default(now())
  factures        Json?
  passeDansCredit Boolean  @default(false)
  estPrevue       Boolean  @default(false)

  // Nouveau : Lien avec transaction bancaire
  transactionBancaireId  String? @unique
  importeAutomatiquement Boolean @default(false)

  // Relations optionnelles
  pieceId     String?
  tacheId     String?
  materiauId  String?
  deblocageId String?

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  // Relations
  projet              Projet               @relation(fields: [projetId], references: [id], onDelete: Cascade)
  piece               Piece?               @relation(fields: [pieceId], references: [id], onDelete: SetNull)
  tache               Tache?               @relation(fields: [tacheId], references: [id], onDelete: SetNull)
  materiau            Materiau?            @relation(fields: [materiauId], references: [id], onDelete: SetNull)
  deblocage           Deblocage?           @relation(fields: [deblocageId], references: [id], onDelete: SetNull)
  transactionBancaire TransactionBancaire?

  @@index([projetId])
  @@index([pieceId])
  @@index([tacheId])
  @@index([materiauId])
  @@index([deblocageId])
  @@index([deletedAt])
  @@index([transactionBancaireId])
}

// --- IdeePinterest ---

model IdeePinterest {
  id          String   @id @default(cuid())
  projetId    String
  url         String
  titre       String?
  description String?
  imageUrl    String?
  couleurs    Json?
  materiaux   Json?
  style       String?
  tags        String[]
  notes       String?

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  // Relations
  projet     Projet           @relation(fields: [projetId], references: [id], onDelete: Cascade)
  moodboards IdeesMoodboard[]

  @@index([projetId])
  @@index([deletedAt])
}

// --- Moodboard ---

model Moodboard {
  id          String  @id @default(cuid())
  projetId    String
  pieceId     String?
  name        String
  description String?
  palette     Json?

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  // Relations
  projet Projet           @relation(fields: [projetId], references: [id], onDelete: Cascade)
  piece  Piece?           @relation(fields: [pieceId], references: [id], onDelete: SetNull)
  idees  IdeesMoodboard[]

  @@index([projetId])
  @@index([pieceId])
  @@index([deletedAt])
}

// --- Table pivot IdeesMoodboard (many-to-many IdeePinterest <-> Moodboard avec ordre) ---

model IdeesMoodboard {
  ideeId      String
  moodboardId String
  ordre       Int    @default(0)

  // Relations
  idee      IdeePinterest @relation(fields: [ideeId], references: [id], onDelete: Cascade)
  moodboard Moodboard     @relation(fields: [moodboardId], references: [id], onDelete: Cascade)

  @@id([ideeId, moodboardId])
  @@index([ideeId])
  @@index([moodboardId])
}

// ============================================================================
// INT√âGRATION BANCAIRE (Powens API)
// ============================================================================

// --- CompteBancaire ---

model CompteBancaire {
  id                      String    @id @default(cuid())
  projetId                String
  userId                  String
  powensItemId            String    @unique // ID de la connexion dans Powens
  powensAccessToken       String? // Token d'acc√®s Powens (crypt√©)
  banque                  String
  derniereSynchronisation DateTime?
  actif                   Boolean   @default(true)

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  // Relations
  projet       Projet                @relation(fields: [projetId], references: [id], onDelete: Cascade)
  user         User                  @relation(fields: [userId], references: [id])
  transactions TransactionBancaire[]

  @@index([projetId])
  @@index([userId])
  @@index([deletedAt])
}

// --- CategorieCustom (Cat√©gories personnalis√©es) ---

enum TypeCategorie {
  DEPENSE
  MATERIAU
  PIECE
}

model CategorieCustom {
  id        String        @id @default(cuid())
  projetId  String
  type      TypeCategorie
  nom       String
  icon      String        @default("üì¶")
  color     String        @default("blue")
  isDefault Boolean       @default(false)

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  // Relations
  projet Projet @relation(fields: [projetId], references: [id], onDelete: Cascade)

  @@index([projetId])
  @@index([type])
  @@index([deletedAt])
}

// --- TransactionBancaire ---

model TransactionBancaire {
  id                   String            @id @default(cuid())
  compteBancaireId     String
  powensTransactionId  String            @unique // ID de la transaction dans Powens
  montant              Float
  description          String
  dateTransaction      DateTime
  categorie            String?
  estDepenseRenovation Boolean           @default(false)
  depenseId            String?           @unique
  statut               StatutTransaction @default(NOUVEAU)
  metadata             Json? // M√©tadonn√©es compl√®tes de Powens

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  compteBancaire CompteBancaire @relation(fields: [compteBancaireId], references: [id], onDelete: Cascade)
  depense        Depense?       @relation(fields: [depenseId], references: [id])

  @@index([compteBancaireId])
  @@index([statut])
  @@index([dateTransaction])
  @@index([depenseId])
}
